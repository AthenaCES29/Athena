#include <stdio.h>
#include <string.h>

typedef struct tabelaDePaginas {
	int id[256];
	int primeira;	/*indice da primeira pagina adicionada na tabela de paginas*/
	int ultima;		/*indice da primeira pagina adicionada na tabela de paginas*/
} tabelaDePaginas;

/*Recebe um ponteiro para a tabela de paginas, um ponteiro para a memoria,
o conteudo da pagina e um id de uma pagina a ser adiconada e adiciona a pagina
a tabela de paginas e seu conteudo a memoria.
A politica de adicao de pagina eh FIFO.*/
void adicionar(tabelaDePaginas* tab, char* memoria, char* pagina,  int id) {
	static int quantidade;
	int i;
	/*Adicionar pagina a tabela*/
	if (tab->ultima == 255)
		tab->ultima = 0;
	else
		tab->ultima++;
	tab->id[tab->ultima] = id;

	/*Adicionar dados a memoria*/
	if (quantidade < 256) {
		quantidade++;
	}
	else {
		if (tab->primeira == 255)
			tab->primeira = 0;
		else
			tab->primeira++;
	}
	for (i = 0; i < 256; i++)
		memoria[tab->primeira*256 + i] = pagina[i];
}

/*Recebe um ponteiro para a tabela de paginas e um id de pagina.
Retorna o indice se a pagina com id dado estiver presente ou -1 se nao estiver*/
int buscarNaTabela(tabelaDePaginas* tab, int id) {
	int i;
	for (i = 0; i < 256; i++) {
		if (tab->id[i] == id)
			return i;
	}
	return -1;
}



void buscarNoSWAP(FILE* swap, unsigned char* pagina, unsigned char* temp, int id) {
	int i;
	char high, low;
	fseek(swap, id*256, SEEK_SET);
	fread(temp, 4, 128, swap);
	for(i = 0; i < 2*256; i = i + 2;) {
		high = temp[i];
		low = temp[i+1];
		if (high >= 48 && high <= 57)
			high = high - 48;
		else
			high = high - 86;
		if (low >= 48 && low <= 57)
			low = low - 48;
		else
			low = low - 86;
		pagina[i/2] = high*16 + low;
	}
}

int main(int argc, char *argv[]) {
	tabelaDePaginas tabela;
	char memoria[256*256];
	char temp[2*256];
	char pagina[256];

	FILE* entrada;
	FILE* swap;
	char string[10];
	char** endptr;
	int va, pa, des, id;
	int mascara16 = 65535;

	int i;

/*Ler id's do arquivo adresses.txt e abrir arquivo de swap*/
	entrada = fopen(argv[1], "r");
	swap = fopen("BACKING_SOTRE.bin", "r");

	if (entrada == NULL) {
		printf("Erro, nao foi possivel abrir o arquivo.\n");
		return -1;
	}
	else {
		
		while (fgets(string, 10, entrada) != NULL) {
			va = strtol(string, endptr, 10);
			va = id & mascara16;
			id = id / 256;
			des = va % 256;
			pa = tabela.primeira*256 + des;

			/*Verificar se a tabela esta na tabela de paginas*/
			if (buscarNaTabela(&tabela, id) == -1) {
				/*Importar para a tabela de paginas e para a memoria*/
				buscarNoSWAP (swap, pagina, id);
				adicionar(&tabela, memoria, pagina, temp, id);
			}
			printf ("Virtual address: %d Physical adress: %d Value: %d\n", va, pa, memoria[pa]);
		}
	}

	fclose(entrada);

	return 0;
}